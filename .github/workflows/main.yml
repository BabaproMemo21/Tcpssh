name: Localtonet SSH Tunnel

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: İndir ve Kur
      run: |
        wget https://localtonet.com/download/localtonet-linux-x64.zip
        unzip localtonet-linux-x64.zip
        chmod +x localtonet
        mv localtonet lt

    - name: SSH Key Oluştur
      id: keygen
      run: |
        ssh-keygen -t rsa -b 4096 -N "" -f id_rsa
        echo "::set-output name=pubkey::$(cat id_rsa.pub)"
        echo "::set-output name=privkey::$(cat id_rsa)"

    - name: SSH Sunucusunu Kur ve Başlat
      run: |
        sudo apt-get update && sudo apt-get install -y openssh-server
        sudo systemctl start ssh
        sudo systemctl enable ssh

    - name: SSH Key’i Authorized Keys’e Ekle
      run: |
        mkdir -p ~/.ssh
        echo "${{ steps.keygen.outputs.pubkey }}" >> ~/.ssh/authorized_keys
        chmod 700 ~/.ssh
        chmod 600 ~/.ssh/authorized_keys

    - name: Localtonet ile TCP Tunnel Aç
      id: tunnel
      run: |
        ./lt authtoken ${{ secrets.AUTH_TOKEN }}
        nohup ./lt tcp --port 22 > tunnel.txt 2>&1 &
        sleep 5
        echo "::set-output name=link::$(grep -Eo '[^ ]+\.localto\.net:[0-9]+' tunnel.txt)"

    - name: Çıktı Bilgisi Ver
      run: |
        echo "🔑 PRIVATE_KEY="
        echo "${{ steps.keygen.outputs.privkey }}"
        echo ""
        echo "📎 Tünel Adresi = ${{ steps.tunnel.outputs.link }}"
        echo ""
        echo "👉 SSH Komutu:"
        echo "ssh -i private_key kullanıcı@${{ steps.tunnel.outputs.link }}"
