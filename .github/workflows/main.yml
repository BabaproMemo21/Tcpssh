name: Localtonet SSH

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Localtonet Kurulumu
      run: |
        wget https://github.com/localtonet/cli/releases/latest/download/localtonet-linux-amd64 -O lt
        chmod +x lt
        sudo mv lt /usr/local/bin/localtonet

    - name: SSH Key OluÅŸtur
      run: |
        ssh-keygen -t rsa -b 4096 -N "" -f id_rsa
        echo "::set-output name=pubkey::$(cat id_rsa.pub)"
      id: keygen

    - name: SSH Key'i Ekle
      run: |
        mkdir -p ~/.ssh
        echo "${{ steps.keygen.outputs.pubkey }}" >> ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys
        echo "Authorized key eklendi"

    - name: SSH Sunucusunu AÃ§
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server
        sudo systemctl start ssh
        sudo systemctl enable ssh

    - name: Localtonet ile BaÄŸlantÄ±yÄ± BaÅŸlat
      run: |
        ./lt --token ${{ secrets.AUTH_TOKEN }} --port 22 > out.txt &
        sleep 5
        echo "::set-output name=sshlink::$(cat out.txt | grep ssh | tail -1)"
      id: lt

    - name: Bilgileri YazdÄ±r
      run: |
        echo "ğŸ”‘ Ã–zel SSH Key:"
        cat id_rsa
        echo ""
        echo "ğŸ“ SSH BaÄŸlantÄ± Linki:"
        echo "${{ steps.lt.outputs.sshlink }}"
        echo ""
        echo "ğŸ‘‰ SSH ile baÄŸlanmak iÃ§in komut:"
        echo "ssh -i id_rsa user@host -p port"
