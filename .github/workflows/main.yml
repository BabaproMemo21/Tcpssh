name: Localtonet SSH TÃ¼neli AÃ§

on:
  workflow_dispatch:

jobs:
  tunnel:
    runs-on: ubuntu-latest

    steps:
    - name: Reposuz baÅŸla
      run: echo "BaÅŸlÄ±yoruz ğŸ”§"

    - name: Localtonet indir ve Ã§Ä±kart
      run: |
        wget https://localtonet.com/download/localtonet-linux-x64.zip
        unzip localtonet-linux-x64.zip
        chmod +x lt

    - name: SSH anahtarlarÄ±nÄ± kur
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        echo "${{ secrets.SSH_PUB_KEY }}" > ~/.ssh/id_rsa.pub
        chmod 600 ~/.ssh/id_rsa
        chmod 644 ~/.ssh/id_rsa.pub
        cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
        chmod 600 ~/.ssh/authorized_keys

    - name: SSH servisini baÅŸlat
      run: |
        sudo apt update
        sudo apt install -y openssh-server
        sudo service ssh start

    - name: Localtonet tÃ¼nelini baÅŸlat
      run: |
        nohup ./lt tcp --token "${{ secrets.AUTH_TOKEN }}" --port 22 > tunnel.log 2>&1 &
        echo "Localtonet tÃ¼neli baÅŸlatÄ±ldÄ±, link bekleniyor..."

    - name: BaÄŸlantÄ± linkini gÃ¶ster
      run: |
        echo "Link oluÅŸturuluyor... LÃ¼tfen 10 saniye bekleyin..."
        sleep 10
        echo "::group::TÃ¼nel Ã‡Ä±kÄ±ÅŸÄ±"
        cat tunnel.log
        echo "::endgroup::"

    - name: SSH ile baÄŸlanmak iÃ§in komut oluÅŸtur
      run: |
        echo "::group::SSH Key (PRIVATE)"
        cat ~/.ssh/id_rsa
        echo "::endgroup::"
        echo "::group::SSH BaÄŸlantÄ± Komutu"
        IPPORT=$(grep -oP 'tcp:\/\/\K[^\s]+' tunnel.log)
        echo "ssh -i privatekey root@$IPPORT"
        echo "::endgroup::"          echo "ssh -i id_ed25519 -o StrictHostKeyChecking=no -p $PORT ubuntu@$HOST"
