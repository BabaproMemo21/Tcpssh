name: Localtonet SSH Tunnel (Non-root)

on:
  workflow_dispatch:
    inputs:
      AUTH_TOKEN:
        description: 'Localtonet Auth Token'
        required: true
        default: ''

jobs:
  tunnel:
    runs-on: ubuntu-latest

    steps:
      - name: Gereken paketleri yÃ¼kle (sudo ile)
        run: |
          sudo apt update
          sudo apt install -y unzip openssh-server

      - name: Localtonet indir ve aÃ§ (normal kullanÄ±cÄ±)
        run: |
          wget https://localtonet.com/download/localtonet-linux-x64.zip
          unzip localtonet-linux-x64.zip
          chmod +x localtonet

      - name: SSH anahtar oluÅŸtur (normal kullanÄ±cÄ±)
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
          mkdir -p ~/.ssh
          cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys

      - name: SSH servisini baÅŸlat (sudo ile)
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh

      - name: Localtonet tÃ¼nelini baÅŸlat (normal kullanÄ±cÄ±)
        run: |
          nohup ./localtonet tcp --token "${{ github.event.inputs.AUTH_TOKEN }}" --port 22 > tunnel.log 2>&1 &
          echo "Localtonet tÃ¼neli baÅŸlatÄ±ldÄ±, baÄŸlantÄ± bekleniyor..."
          sleep 15

      - name: BaÄŸlantÄ± linkini al ve ssh komutunu yazdÄ±r
        run: |
          LINK=$(grep -oP 'tcp://\K[^ ]+' tunnel.log | head -n1)
          if [ -z "$LINK" ]; then
            echo "â€¼ï¸ Localtonet baÄŸlantÄ± linki bulunamadÄ±."
            exit 1
          fi
          HOST=$(echo $LINK | cut -d':' -f1)
          PORT=$(echo $LINK | cut -d':' -f2)
          echo "ğŸ”‘ Private key (~/.ssh/id_rsa):"
          cat ~/.ssh/id_rsa
          echo ""
          echo "ğŸ“¡ Localtonet baÄŸlantÄ± linki: $LINK"
          echo ""
          echo "ğŸ’» SSH ile baÄŸlanmak iÃ§in komut:"
          echo "ssh -i ~/.ssh/id_rsa -p $PORT root@$HOST"
